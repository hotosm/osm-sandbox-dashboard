<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Sandbox</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .small-muted { font-size: 0.9rem; color: #6c757d; }
    </style>
</head>

<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Login OSM Sandbox</h3>
                    </div>
                    <div class="card-body">
                        <form id="loginForm">
                            <div class="form-group">
                                <label for="box">Box:</label>
                                <select class="form-control" id="box" name="box" required>
                                    <option value="">Select a box</option>
                                </select>
                            </div>

                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="useRedirect">
                                <label class="form-check-label small-muted" for="useRedirect">
                                    Use a custom callback URL (optional)
                                </label>
                            </div>

                            <div class="form-group d-none" id="redirectGroup">
                                <label for="endRedirectUri">Callback URL (end_redirect_uri)</label>
                                <input type="url" class="form-control" id="endRedirectUri" placeholder="https://dashboard_url/session/token">
                                <small class="form-text text-muted">Only send if you want the server to redirect to this URL after authentication. Leave empty to not send. To obtain the token hit the dashboard url in placeholder.</small>
                            </div>

                            <button type="submit" class="btn btn-primary btn-block">Login with OpenStreetMap</button>
                        </form>

                        <div id="tokenInfo" class="mt-4 d-none">
                            <h4>Sandbox Access Token</h4>
                            <div class="alert alert-info">
                                <p><strong>Token:</strong> <span id="accessToken"></span></p>
                                <p><strong>Expires in:</strong> <span id="expiresIn"></span> seconds</p>
                                <p><strong>API URL:</strong> <span id="apiUrl"></span></p>
                            </div>
                            <button id="loginSandboxBtn" class="btn btn-success">Login to Sandbox</button>
                        </div>

                        <div id="messages" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const useRedirectCheckbox = document.getElementById('useRedirect');
            const redirectGroup = document.getElementById('redirectGroup');
            const endRedirectInput = document.getElementById('endRedirectUri');
            const messages = document.getElementById('messages');

            function setMessage(text, isError = false) {
                messages.innerHTML = text ? `<div class="alert ${isError ? 'alert-danger' : 'alert-info'}">${text}</div>` : '';
            }

            useRedirectCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    redirectGroup.classList.remove('d-none');
                } else {
                    redirectGroup.classList.add('d-none');
                    endRedirectInput.value = '';
                }
            });

            // Populate box dropdown
            fetch('/v1/boxes')
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch boxes');
                    return response.json();
                })
                .then(data => {
                    const boxSelect = document.getElementById('box');
                    data.forEach(box => {
                        const option = document.createElement('option');
                        option.value = box.name;
                        option.textContent = `${box.name} (${box.license})`;
                        boxSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching boxes:', error);
                    setMessage('Error fetching boxes. Check server logs or /v1/boxes endpoint.', true);
                });

            // Handle form submission
            document.getElementById('loginForm').addEventListener('submit', function (event) {
                event.preventDefault();
                setMessage('');
                const box = document.getElementById('box').value;
                if (!box) {
                    alert('Please select a box');
                    return;
                }

                // Build POST URL; only append end_redirect_uri if provided by user
                let url = `/sessions?box=${encodeURIComponent(box)}`;

                if (useRedirectCheckbox.checked) {
                    const endRedirect = endRedirectInput.value.trim();
                    if (endRedirect) {
                        // basic validation: must be absolute http/https url
                        try {
                            const parsed = new URL(endRedirect);
                            if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') {
                                alert('Callback URL must start with http:// or https://');
                                return;
                            }
                            url += `&end_redirect_uri=${encodeURIComponent(endRedirect)}`;
                        } catch (e) {
                            alert('Please provide a valid callback URL.');
                            return;
                        }
                    } else {
                        // checkbox checked but no URL entered -> do not send the param
                    }
                }

                // Create new session
                fetch(url, {
                    method: 'POST'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(`${response.status} ${text}`); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.id) {
                        // Redirect for OAuth with session ID as state
                        window.location.href = `/osm_authorization?session_id=${encodeURIComponent(data.id)}`;
                    } else {
                        throw new Error('Failed to create session');
                    }
                })
                .catch(error => {
                    console.error('Error creating session:', error);
                    setMessage('Error creating session. Please try again (see console).', true);
                });
            });

            // Check for session_id in URL after OAuth redirect
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            if (sessionId) {
                // Retrieve sandbox token (existing behavior)
                fetch(`/sessions/${encodeURIComponent(sessionId)}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Token fetch failed');
                        return response.json();
                    })
                    .then(tokenData => {
                        document.getElementById('accessToken').textContent = tokenData.access_token;
                        document.getElementById('expiresIn').textContent = tokenData.expires_in;
                        document.getElementById('apiUrl').textContent = tokenData.sandbox_api_url;
                        document.getElementById('tokenInfo').classList.remove('d-none');

                        // Store token for sandbox login
                        sessionStorage.setItem('sandboxToken', tokenData.access_token);
                        sessionStorage.setItem('sandboxApiUrl', tokenData.sandbox_api_url);
                    })
                    .catch(error => {
                        console.error('Error fetching token:', error);
                        setMessage('Failed to retrieve sandbox token. Please try logging in again.', true);
                    });
            }

            // Handle sandbox login
            document.getElementById('loginSandboxBtn')?.addEventListener('click', function() {
                const token = sessionStorage.getItem('sandboxToken');
                const apiUrl = sessionStorage.getItem('sandboxApiUrl');

                if (token && apiUrl) {
                    // Example: Use token with sandbox API
                    fetch(`${apiUrl}/api/0.6/user/details.json`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                    .then(response => response.json())
                    .then(userData => {
                        alert(`Logged in as ${userData.user?.display_name}`);
                        // Redirect to sandbox UI or perform other actions
                    })
                    .catch(error => {
                        console.error('Sandbox API error:', error);
                        alert('Error accessing sandbox API');
                    });
                } else {
                    alert('No sandbox token available. Please login first.');
                }
            });
        });
    </script>
</body>
</html>
