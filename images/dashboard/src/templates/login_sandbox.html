<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Sandbox</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Login OSM Sandbox</h3>
                    </div>
                    <div class="card-body">
                        <form id="loginForm">
                            <div class="form-group">
                                <label for="box">Box:</label>
                                <select class="form-control" id="box" name="box" required>
                                    <option value="">Select a box</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Login with OpenStreetMap</button>
                        </form>
                        <div id="tokenInfo" class="mt-4 d-none">
                            <h4>Sandbox Access Token</h4>
                            <div class="alert alert-info">
                                <p><strong>Token:</strong> <span id="accessToken"></span></p>
                                <p><strong>Expires in:</strong> <span id="expiresIn"></span> seconds</p>
                                <p><strong>API URL:</strong> <span id="apiUrl"></span></p>
                            </div>
                            <button id="loginSandboxBtn" class="btn btn-success">Login to Sandbox</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Populate box dropdown
            fetch('/v1/boxes')
                .then(response => response.json())
                .then(data => {
                    const boxSelect = document.getElementById('box');
                    data.forEach(box => {
                        const option = document.createElement('option');
                        option.value = box.name;
                        option.textContent = `${box.name} (${box.license})`;
                        boxSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching boxes:', error));

            // Handle form submission
            document.getElementById('loginForm').addEventListener('submit', function (event) {
                event.preventDefault();
                const box = document.getElementById('box').value;
                if (!box) {
                    alert('Please select a box');
                    return;
                }

                // Create new session
                fetch(`/sessions?box=${encodeURIComponent(box)}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.id) {
                        // Redirect for OAuth with session ID as state
                        window.location.href = `/osm_authorization?session_id=${data.id}`;
                    } else {
                        throw new Error('Failed to create session');
                    }
                })
                .catch(error => {
                    console.error('Error creating session:', error);
                    alert('Error creating session. Please try again.');
                });
            });

            // Check for session_id in URL after OAuth redirect
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            
            if (sessionId) {
                // Retrieve sandbox token
                fetch(`/sessions/${sessionId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Token fetch failed');
                        return response.json();
                    })
                    .then(tokenData => {
                        document.getElementById('accessToken').textContent = tokenData.access_token;
                        document.getElementById('expiresIn').textContent = tokenData.expires_in;
                        document.getElementById('apiUrl').textContent = tokenData.sandbox_api_url;
                        document.getElementById('tokenInfo').classList.remove('d-none');
                        
                        // Store token for sandbox login
                        sessionStorage.setItem('sandboxToken', tokenData.access_token);
                        sessionStorage.setItem('sandboxApiUrl', tokenData.sandbox_api_url);
                    })
                    .catch(error => {
                        console.error('Error fetching token:', error);
                        alert('Failed to retrieve sandbox token. Please try logging in again.');
                    });
            }

            // Handle sandbox login
            document.getElementById('loginSandboxBtn')?.addEventListener('click', function() {
                const token = sessionStorage.getItem('sandboxToken');
                const apiUrl = sessionStorage.getItem('sandboxApiUrl');
                
                if (token && apiUrl) {
                    // Example: Use token with sandbox API
                    fetch(`${apiUrl}/api/0.6/user/details.json`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                    .then(response => response.json())
                    .then(userData => {
                        alert(`Logged in as ${userData.user?.display_name}`);
                        // Redirect to sandbox UI or perform other actions
                    })
                    .catch(error => {
                        console.error('Sandbox API error:', error);
                        alert('Error accessing sandbox API');
                    });
                }
            });
        });
    </script>
</body>
</html>