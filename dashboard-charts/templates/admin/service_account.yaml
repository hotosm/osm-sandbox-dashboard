{{- if .Values.service_account.create -}}

# ClusterRole granting read-only access to a set of cluster resources
apiVersion: rbac.authorization.k8s.io/v1 # RBAC API version used for Role/ClusterRole objects
kind: ClusterRole # object kind: a ClusterRole is cluster-scoped (not limited to one namespace)
metadata: # metadata block describing the object
  name: readonly-resources # the name of this ClusterRole object
rules: # list of permission rules that define what this ClusterRole allows
  - apiGroups: [""] # first rule: applies to the core API group (empty string = core)
    resources: # list of core resources included in this rule
      [
        "pods",
        "services",
        "endpoints",
        "configmaps",
        "persistentvolumeclaims",
        "persistentvolumes",
        "nodes",
        "secrets",
      ] # end list of core resources
    verbs: ["get", "list", "watch"] # allowed read-only verbs for the listed core resources
  - apiGroups: ["apps", "extensions"] # next rule: covers the "apps" and "extensions" API groups (controllers)
    resources: ["deployments", "replicasets", "statefulsets", "daemonsets"] # controller resources to be read-only
    verbs: ["get", "list", "watch"] # allowed read-only verbs for controller resources
  - apiGroups: ["batch"] # next rule applies to batch API group (jobs/cronjobs)
    resources: ["jobs", "cronjobs"] # batch resources included
    verbs: ["get", "list", "watch"] # read-only verbs for batch resources
  - apiGroups: ["rbac.authorization.k8s.io"] # includes RBAC objects themselves
    resources: ["roles", "clusterroles", "rolebindings", "clusterrolebindings"] # RBAC resources to be read
    verbs: ["get", "list", "watch"] # read-only verbs for RBAC resources

---
# ClusterRoleBinding to attach the above ClusterRole to the ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1 # RBAC API version used for bindings
kind: ClusterRoleBinding # object kind: cluster-scoped binding (binds ClusterRole to subjects across cluster)
metadata: # metadata for the binding
  name: helm-svc-readonly-binding # name of this ClusterRoleBinding
subjects: # who (which subjects) receive the role
  - kind: ServiceAccount # subject kind: a ServiceAccount
    name: helm-service-account # name of the ServiceAccount to grant permissions to
    namespace: {{ .Values.namespace }} # namespace where the ServiceAccount resides
roleRef: # reference to the role being granted
  kind: ClusterRole # the referenced role is a ClusterRole
  name: readonly-resources # name of the ClusterRole to bind
  apiGroup: rbac.authorization.k8s.io # API group of the role reference

---
# Role granting full CRUD permissions for selected resources inside the tm-sandbox namespace
apiVersion: rbac.authorization.k8s.io/v1 # RBAC API version for the namespaced Role
kind: Role # object kind: Role (namespaced permissions only)
metadata: # metadata for the Role
  name: tm-sandbox-namespaced-crud # name of the Role that grants CRUD inside the namespace
  namespace: {{ .Values.namespace }} # the namespace this Role applies to (tm-sandbox)
rules: # list of rules defining what this Role allows inside tm-sandbox
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["*"]

---
# RoleBinding to attach the namespace Role to the ServiceAccount inside tm-sandbox
apiVersion: rbac.authorization.k8s.io/v1 # RBAC API version for RoleBinding
kind: RoleBinding # object kind: RoleBinding (namespaced)
metadata: # metadata for the RoleBinding
  name: helm-svc-tm-sandbox-namespaced-crud-binding # name of this RoleBinding
  namespace: {{ .Values.namespace }} # namespace where the RoleBinding lives and applies
subjects: # who gets the Role's permissions in this namespace
  - kind: ServiceAccount # subject kind: ServiceAccount
    name: helm-service-account # name of the ServiceAccount to bind the Role to
    namespace: {{ .Values.namespace }} # namespace of the ServiceAccount (must match where the SA exists)
roleRef: # reference to the Role being granted
  kind: Role # the referenced object is a Role (namespaced)
  name: tm-sandbox-namespaced-crud # name of the Role to grant
  apiGroup: rbac.authorization.k8s.io # API group for the role reference

---
# Role granting full CRUD permissions for selected resources inside the tm-sandbox namespace
apiVersion: rbac.authorization.k8s.io/v1 # RBAC API version for the namespaced Role
kind: Role # object kind: Role (namespaced permissions only)
metadata: # metadata for the Role
  name: tm-sandbox-namespaced-crud # name of the Role that grants CRUD inside the namespace
  namespace: default # the namespace this Role applies to (tm-sandbox)
rules: # list of rules defining what this Role allows inside tm-sandbox
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["*"]

---
# RoleBinding to attach the namespace Role to the ServiceAccount inside tm-sandbox
apiVersion: rbac.authorization.k8s.io/v1 # RBAC API version for RoleBinding
kind: RoleBinding # object kind: RoleBinding (namespaced)
metadata: # metadata for the RoleBinding
  name: helm-svc-tm-sandbox-namespaced-crud-binding # name of this RoleBinding
  namespace: default # namespace where the RoleBinding lives and applies
subjects: # who gets the Role's permissions in this namespace
  - kind: ServiceAccount # subject kind: ServiceAccount
    name: helm-service-account # name of the ServiceAccount to bind the Role to
    namespace: {{ .Values.namespace }} # namespace of the ServiceAccount (must match where the SA exists)
roleRef: # reference to the Role being granted
  kind: Role # the referenced object is a Role (namespaced)
  name: tm-sandbox-namespaced-crud # name of the Role to grant
  apiGroup: rbac.authorization.k8s.io # API group for the role reference

{{- end -}}